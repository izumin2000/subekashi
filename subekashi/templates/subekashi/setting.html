{% extends "subekashi/base/base.html" %}


{% load static %}
{% block css %}{% static 'subekashi/css/setting.css'%}{% endblock %}

{% block content %}
<section>
    <h1>設定</h1>
    <div class="underline"></div>

    {% with top_settings=settings.top search_settings=settings.search song_settings=settings.song edit_settings=settings.edit %}
    <h2>トップ画面</h2>
    {% for setting in top_settings %}
        <div class="form-col">
            <label>{{ setting.label }}</label>
            <select id="{{ setting.id }}" class="setting-input">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}

    {% comment %} <h2>検索画面</h2>
    {% for setting in search_settings %}
        <div class="form-col">
            <label>{{ setting.label }}<i class="fas fa-info-circle" onclick="showTutorial('select');"></i></label>
            <select id="{{ setting.id }}" class="setting-input">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %} {% endcomment %}

    <h2>曲画面</h2>
    {% for setting in song_settings %}
        <div class="form-col">
            <label>{{ setting.label }}</label>
            <select id="{{ setting.id }}" class="setting-input">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}

    <h2>新規作成/編集画面</h2>
    {% for setting in edit_settings %}
        <div class="form-col">
            <label>{{ setting.label }}</label>
            <select id="{{ setting.id }}" class="setting-input edit-setting">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}
    {% endwith %}
</section>
{% endblock %}

{% block js %}
<script defer>
    window.addEventListener('load', function(){
        restoreFormValuesFromCookies();

        // 全てのsetting-inputに変更イベントリスナーを追加
        const settingInputs = document.querySelectorAll('.setting-input');
        settingInputs.forEach(input => {
            input.addEventListener('change', handleInputChange);
        });
    });

    window.addEventListener('pageshow', function (event) {
        if (event.persisted) {
            restoreFormValuesFromCookies();
        }
    });

    // 他のページからブラウザバックしたとき、フォームの内容をcookieの値に反映する
    function restoreFormValuesFromCookies() {
        const cookies = getCookie();
        const settingInputs = document.querySelectorAll('.setting-input:not(.edit-setting)');

        settingInputs.forEach(input => {
            const cookieValue = cookies[input.id];
            if (cookieValue && input.value !== cookieValue) {
                input.value = cookieValue;
            }
        });
    }

    async function handleInputChange(e) {
        const input = e.target;

        // edit-settingクラスの場合は別処理
        if (input.classList.contains('edit-setting')) {
            change_is_open();
            return;
        }

        // 変更された設定を即座に保存
        await saveSingleSetting(input.id, input.value);
    }

    async function saveSingleSetting(key, value) {
        try {
            const csrf = await getCSRF();

            const res = await fetch(
                baseURL() + "/api/setting/save/",
                {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf
                    },
                    body: JSON.stringify({ cookies: { [key]: value } })
                }
            );

            const data = await res.json();

            if (data.status !== 'success') {
                console.error('保存に失敗しました:', data.message);
            }
        } catch (error) {
            console.error('エラーが発生しました:', error);
        }
    }

    async function change_is_open() {
        try {
            const csrf = await getCSRF();
            const is_open_value = document.getElementById("is_open").value;
            const res = await fetch(
                baseURL() + "/api/editor/is_open",
                {
                    method: "PUT",
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf
                    },
                    body: JSON.stringify(
                        {
                            "ip": "{{ editor.ip }}",
                            "is_open": is_open_value == "on",
                        }
                    )
                }
            )
        } catch (error) {
            console.error(error)
        }
    }
</script>
{% endblock %}
