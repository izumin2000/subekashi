{% extends "subekashi/base/base.html" %}


{% load static %}
{% block css %}{% static 'subekashi/css/setting.css'%}{% endblock %}

{% block content %}
<section>
    <h1>設定</h1>
    <div class="underline"></div>

    {% with top_settings=settings.top search_settings=settings.search song_settings=settings.song edit_settings=settings.edit %}
    <h2>トップ画面</h2>
    {% for setting in top_settings %}
        <div class="form-col">
            <label>{{ setting.label }}</label>
            <select id="{{ setting.id }}" onchange="setting()">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}

    <h2>検索画面</h2>
    {% for setting in search_settings %}
        <div class="form-col">
            <label>{{ setting.label }}<i class="fas fa-info-circle" onclick="showTutorial('select');"></i></label>
            <select id="{{ setting.id }}" onchange="setting()">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}

    <h2>曲画面</h2>
    {% for setting in song_settings %}
        <div class="form-col">
            <label>{{ setting.label }}</label>
            <select id="{{ setting.id }}" onchange="setting()">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}

    <h2>新規作成/編集画面</h2>
    {% for setting in edit_settings %}
        <div class="form-col">
            <label>{{ setting.label }}</label>
            <select id="{{ setting.id }}" onchange="change_is_open()">
                {% for option in setting.options %}
                <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.text }}</option>
                {% endfor %}
            </select>
        </div>
    {% endfor %}
    {% endwith %}
</section>
{% endblock %}

{% block js %}
<script defer>
    var selectEles = document.getElementsByTagName("select");

    function setting(isUpdate = true) {
        var i = 0;
        for (selectEle of selectEles) {
            const selectId = selectEle.getAttribute('id');
            value = getCookie()[selectId];
            if ((value === undefined) || isUpdate) {
                setCookie(selectId, selectEle.value);
            } else {
                selectEle.value = value;
            }
            i++;
        }
    }


    async function change_is_open() {
        try {
            const csrf = await getCSRF();
            const is_open_value = document.getElementById("is_open").value;
            const res = await fetch(
            baseURL() + "/api/editor/is_open",
            {
                method: "PUT",
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify(
                    {
                        "ip": "{{ editor.ip }}",
                        "is_open": is_open_value == "on",
                    }
                )
            }
        )
        } catch (error) {
            console.error(error)
        }
        
    }

    window.addEventListener('load', function(){
        setting(false);
    });
</script>
{% endblock %}
